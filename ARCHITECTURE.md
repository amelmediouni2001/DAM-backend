# Avatar System - Architecture & Flow Diagrams

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Mobile Applications                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚   Android App    â”‚                â”‚    iOS App       â”‚       â”‚
â”‚  â”‚   (Kotlin)       â”‚                â”‚    (SwiftUI)     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                    â”‚
            â”‚  HTTP/HTTPS Requests               â”‚
            â”‚  with JWT Token                    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                         â”‚                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                              â”‚
           â”‚    NestJS Backend API                       â”‚
           â”‚    http://localhost:3000                    â”‚
           â”‚                                              â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚  Authentication Module               â”‚   â”‚
           â”‚  â”‚  (Auth Controller, JWT, Passport)   â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                              â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚  Avatar Module                       â”‚   â”‚
           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
           â”‚  â”‚  â”‚ Avatar Controller              â”‚  â”‚   â”‚
           â”‚  â”‚  â”‚ - CRUD operations              â”‚  â”‚   â”‚
           â”‚  â”‚  â”‚ - Gameplay endpoints           â”‚  â”‚   â”‚
           â”‚  â”‚  â”‚ - Outfit management            â”‚  â”‚   â”‚
           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
           â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
           â”‚  â”‚  â”‚ Avatar Service                 â”‚  â”‚   â”‚
           â”‚  â”‚  â”‚ - Business logic               â”‚  â”‚   â”‚
           â”‚  â”‚  â”‚ - Data validation              â”‚  â”‚   â”‚
           â”‚  â”‚  â”‚ - Error handling               â”‚  â”‚   â”‚
           â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                              â”‚
           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
           â”‚  â”‚  Swagger Documentation               â”‚   â”‚
           â”‚  â”‚  (Interactive API Docs)              â”‚   â”‚
           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
           â”‚                                              â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   MongoDB Database      â”‚  â”‚  File Storage      â”‚
      â”‚                         â”‚  â”‚  (Avatar Images)   â”‚
      â”‚  Collections:           â”‚  â”‚  (Optional CDN)    â”‚
      â”‚  - avatars              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚  - users                â”‚
      â”‚  - levels               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Avatar Creation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                  â”‚
â”‚  1. User Opens "Create Avatar" Screen                           â”‚
â”‚     â””â”€> Shows customization options                            â”‚
â”‚         - Style selection (anime, cartoon, etc)                â”‚
â”‚         - Body, skin, hair customization                       â”‚
â”‚         - Clothing & accessories                               â”‚
â”‚                                                                  â”‚
â”‚  2. User Fills Form & Clicks "Create"                          â”‚
â”‚     â””â”€> Validates form data                                    â”‚
â”‚         â””â”€> Sends to backend                                   â”‚
â”‚            POST /api/avatars                                   â”‚
â”‚            Body: { name, customization, avatarImageUrl }      â”‚
â”‚            Header: Authorization: Bearer <JWT>                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Request
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NestJS Backend                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                  â”‚
â”‚  3. Avatar Controller Receives Request                          â”‚
â”‚     â””â”€> @Post() create(@Request() req, @Body() dto)           â”‚
â”‚         â””â”€> Extracts userId from JWT token                    â”‚
â”‚             req.user.id = "507f1f77bcf86cd799439010"          â”‚
â”‚                                                                  â”‚
â”‚  4. Avatar Service Creates Avatar                              â”‚
â”‚     â””â”€> new Avatar({                                           â”‚
â”‚           userId: ObjectId(userId),                            â”‚
â”‚           name: dto.name,                                      â”‚
â”‚           customization: dto.customization,                    â”‚
â”‚           energy: 100,                                         â”‚
â”‚           experience: 0,                                       â”‚
â”‚           level: 1,                                            â”‚
â”‚           isActive: true,                                      â”‚
â”‚           outfits: { unlocked: ["outfit_default"], ... }      â”‚
â”‚         })                                                      â”‚
â”‚         â””â”€> Saves to MongoDB                                   â”‚
â”‚             db.avatars.insertOne(avatarDocument)              â”‚
â”‚                                                                  â”‚
â”‚  5. Service Returns Avatar                                     â”‚
â”‚     â””â”€> Controller Returns 201 Created Response                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Response (201 Created)
                      â”‚ { _id, userId, name, customization, ... }
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                  â”‚
â”‚  6. Frontend Receives Response                                  â”‚
â”‚     â””â”€> Parses JSON response                                   â”‚
â”‚         â””â”€> Updates UI with new avatar                         â”‚
â”‚             â””â”€> Shows avatar in avatar list                    â”‚
â”‚                 â””â”€> Navigates to main screen                   â”‚
â”‚                     â””â”€> Avatar ready to use!                   â”‚
â”‚                                                                  â”‚
â”‚  Success! Avatar "Luna" created! ğŸ‰                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ® Gameplay Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ During Piano Practice Session                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                   â”‚
â”‚  1. User Starts Level                                            â”‚
â”‚     â””â”€> GET /api/avatars/active                                 â”‚
â”‚         â””â”€> Fetch active avatar                                 â”‚
â”‚            â””â”€> Display avatar on screen                         â”‚
â”‚               â””â”€> Avatar state: "idle"                          â”‚
â”‚                   Avatar expression: "happy"                    â”‚
â”‚                   Avatar energy: 100                            â”‚
â”‚                                                                   â”‚
â”‚  2. Level Starts                                                 â”‚
â”‚     â””â”€> PUT /api/avatars/{id}/state                             â”‚
â”‚         Body: { "state": "playing" }                            â”‚
â”‚         â””â”€> Avatar enters "playing" state                       â”‚
â”‚            â””â”€> Shows playing animation                          â”‚
â”‚                                                                   â”‚
â”‚  3. User Plays Piano                                             â”‚
â”‚     â””â”€> Every 10 seconds:                                       â”‚
â”‚         PUT /api/avatars/{id}/energy                            â”‚
â”‚         Body: { "energyDelta": -5 }                             â”‚
â”‚         â””â”€> Energy decreases as avatar assists                  â”‚
â”‚            â””â”€> Update energy bar UI                             â”‚
â”‚                                                                   â”‚
â”‚  4. User Makes Mistake                                           â”‚
â”‚     â””â”€> PUT /api/avatars/{id}/expression                        â”‚
â”‚         Body: { "expression": "thinking" }                      â”‚
â”‚         â””â”€> Avatar shows thinking face                          â”‚
â”‚            â””â”€> Provides encouragement dialog                    â”‚
â”‚                                                                   â”‚
â”‚  5. User Successfully Completes Piece                            â”‚
â”‚     â””â”€> PUT /api/avatars/{id}/state                             â”‚
â”‚         Body: { "state": "celebrating" }                        â”‚
â”‚         â””â”€> Avatar shows celebration animation                  â”‚
â”‚            â””â”€> POST /api/avatars/{id}/experience                â”‚
â”‚               Body: { "xpGain": 100 }                            â”‚
â”‚               â””â”€> Avatar gains 100 XP                           â”‚
â”‚                   â””â”€> Level increases if XP >= 100              â”‚
â”‚                      â””â”€> Unlock achievement/outfit               â”‚
â”‚                         â””â”€> Show level up animation!             â”‚
â”‚                                                                   â”‚
â”‚  6. Session Ends                                                 â”‚
â”‚     â””â”€> Avatar energy restored for next session                â”‚
â”‚         â””â”€> Player progress saved                               â”‚
â”‚             â””â”€> Ready for next level!                           â”‚
â”‚                                                                   â”‚
â”‚  Score: 1000 | Avatar XP: +100 | Level: 2 | Achievements: 2    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App - Login                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 1. User Logs In (Google/Facebook/Email)                      â”‚
â”‚    â””â”€> POST /auth/login or /auth/google/callback             â”‚
â”‚        â””â”€> Backend validates credentials                     â”‚
â”‚           â””â”€> Generates JWT token                            â”‚
â”‚              â””â”€> Returns token to mobile                     â”‚
â”‚                 â””â”€> Mobile stores token securely             â”‚
â”‚                    (SharedPreferences / Keychain)            â”‚
â”‚                                                               â”‚
â”‚ 2. JWT Token Structure                                        â”‚
â”‚    â””â”€> Header: { alg: "HS256", typ: "JWT" }                 â”‚
â”‚    â””â”€> Payload: {                                            â”‚
â”‚          id: "507f1f77bcf86cd799439010",    // userId        â”‚
â”‚          email: "user@example.com",                          â”‚
â”‚          iat: 1234567890,                   // issued at     â”‚
â”‚          exp: 1234671490                    // expires at    â”‚
â”‚        }                                                      â”‚
â”‚    â””â”€> Signature: HMAC(header + payload, JWT_SECRET)         â”‚
â”‚                                                               â”‚
â”‚ 3. Store Token                                                â”‚
â”‚    â””â”€> Mobile App: Save "eyJhbGc..." to local storage        â”‚
â”‚        â””â”€> Available for all API requests during session    â”‚
â”‚           â””â”€> Auto-attach to Authorization header            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ JWT Token Stored Securely
                â”‚ "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App - API Requests                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ For every API call:                                           â”‚
â”‚                                                               â”‚
â”‚ POST /api/avatars                                            â”‚
â”‚ Headers: {                                                   â”‚
â”‚   "Authorization": "Bearer eyJhbGc...",    // JWT Token      â”‚
â”‚   "Content-Type": "application/json"                        â”‚
â”‚ }                                                             â”‚
â”‚ Body: { "name": "Luna", "customization": {...} }            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ Request with Token
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NestJS Backend - JWT Middleware                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 1. Extract Token from Header                                 â”‚
â”‚    â””â”€> Get "Bearer eyJhbGc..." from Authorization header    â”‚
â”‚        â””â”€> Remove "Bearer " prefix                           â”‚
â”‚           â””â”€> Token = "eyJhbGc..."                           â”‚
â”‚                                                               â”‚
â”‚ 2. Verify Token Signature                                    â”‚
â”‚    â””â”€> Decode token using JWT_SECRET                        â”‚
â”‚        â””â”€> Verify signature matches                          â”‚
â”‚           â””â”€> Token is VALID âœ“                              â”‚
â”‚              (or INVALID/EXPIRED âœ—)                          â”‚
â”‚                                                               â”‚
â”‚ 3. Extract User Info                                         â”‚
â”‚    â””â”€> payload.id = "507f1f77bcf86cd799439010"             â”‚
â”‚        â””â”€> Attach to req.user.id                            â”‚
â”‚           â””â”€> Available in controller/service                â”‚
â”‚              â””â”€> req.user.id used for database queries       â”‚
â”‚                  (ensures user can only access own data)     â”‚
â”‚                                                               â”‚
â”‚ 4. Continue or Reject                                        â”‚
â”‚    âœ“ Valid Token  â†’ Process request                         â”‚
â”‚    âœ— Invalid/Missing â†’ Return 401 Unauthorized              â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow - Experience & Leveling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/avatars/{id}/experience                          â”‚
â”‚ Body: { "xpGain": 100 }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Avatar Service - addExperience()                           â”‚
â”‚                                                             â”‚
â”‚  1. Calculate New Experience                               â”‚
â”‚     Current XP:    50                                       â”‚
â”‚     XP Gain:     + 100                                      â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚     New Total:   = 150                                      â”‚
â”‚                                                             â”‚
â”‚  2. Calculate New Level                                    â”‚
â”‚     Level = floor(totalXP / 100) + 1                       â”‚
â”‚     Level = floor(150 / 100) + 1 = 2                       â”‚
â”‚                                                             â”‚
â”‚  3. Update Database                                        â”‚
â”‚     db.avatars.updateOne(                                  â”‚
â”‚       { _id: ObjectId(...) },                              â”‚
â”‚       { $set: {                                            â”‚
â”‚           experience: 150,                                 â”‚
â”‚           level: 2                                         â”‚
â”‚         }                                                  â”‚
â”‚       }                                                    â”‚
â”‚     )                                                       â”‚
â”‚                                                             â”‚
â”‚  4. Return Updated Avatar                                 â”‚
â”‚     { _id, name, level: 2, experience: 150, ... }         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Updated Avatar Data
                     â”‚ { level: 2, experience: 150 }
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App - Update UI                                     â”‚
â”‚                                                             â”‚
â”‚ Level: 2 âœ¨ (increased from 1)                             â”‚
â”‚ XP: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 150/200  (progress bar)               â”‚
â”‚                                                             â”‚
â”‚ ğŸ‰ Level Up! ğŸ‰                                             â”‚
â”‚ "Luna has grown stronger!"                                 â”‚
â”‚                                                             â”‚
â”‚ Unlock reward:                                              â”‚
â”‚ + outfit_casual unlocked!                                   â”‚
â”‚ + 50 bonus energy!                                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸª Outfit System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Avatar Outfits Data Structure                              â”‚
â”‚                                                             â”‚
â”‚ outfits: {                                                  â”‚
â”‚   unlocked: [                                               â”‚
â”‚     "outfit_default",      â† Always unlocked               â”‚
â”‚     "outfit_casual",       â† Unlocked by level up          â”‚
â”‚     "outfit_premium"       â† Unlocked by achievement       â”‚
â”‚   ],                                                        â”‚
â”‚   equipped: "outfit_casual" â† Currently wearing            â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Workflow:
â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. User reaches Level 3
   â””â”€> Triggers unlock event
       â””â”€> POST /api/avatars/{id}/outfits/outfit_casual/unlock
           â””â”€> Added to outfits.unlocked array
               â””â”€> Notification: "New outfit unlocked!"

2. User clicks "Equip Outfit"
   â””â”€> POST /api/avatars/{id}/outfits/outfit_casual/equip
       â””â”€> Check: Is outfit in unlocked list?
           â””â”€> YES: Set outfits.equipped = "outfit_casual"
               â””â”€> Avatar now wearing casual outfit!
           â””â”€> NO: Return error "Outfit not unlocked"

3. Avatar Display
   â””â”€> Show outfit image based on equipped outfit ID
       â””â”€> outfit_default â†’ default image
           outfit_casual â†’ casual image
           outfit_premium â†’ premium image (animated?)
```

---

## âš¡ Energy System

```
Max Energy: 100
Min Energy: 0

Gameplay:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Starting energy:     100 (full)
Per 10 sec played:   -5 (assisting player)
Hour of gameplay:    -30 (accumulated)

Recovery:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Natural recovery:    +1 per 5 minutes (passive)
Sleep/Rest:          +50 (once per day)
Resting item:        +20 (consumable)

UI Representation:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
100 (â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ) Green   - Excellent
75  (â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘) Green   - Good
50  (â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘) Yellow  - Medium
25  (â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘) Orange  - Low
0   (â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘) Red     - Exhausted

If energy = 0:
â””â”€> Avatar cannot assist
    â””â”€> Display warning: "Avatar is tired!"
        â””â”€> "Let them rest"
```

---

## ğŸ—‚ï¸ Database Relations

```
User (existing)
â””â”€â”€ id (ObjectId)
â””â”€â”€ email
â””â”€â”€ name
â””â”€â”€ profile info
    â”‚
    â””â”€â”€ has many Avatars
        â”‚
        â””â”€â”€ Avatar Document
            â”œâ”€â”€ _id (ObjectId)
            â”œâ”€â”€ userId (ref to User)
            â”œâ”€â”€ name
            â”œâ”€â”€ customization
            â”‚   â”œâ”€â”€ style
            â”‚   â”œâ”€â”€ bodyType
            â”‚   â”œâ”€â”€ skinTone
            â”‚   â”œâ”€â”€ hairstyle
            â”‚   â”œâ”€â”€ hairColor
            â”‚   â”œâ”€â”€ eyeStyle
            â”‚   â”œâ”€â”€ eyeColor
            â”‚   â”œâ”€â”€ clothingType
            â”‚   â”œâ”€â”€ clothingColor
            â”‚   â””â”€â”€ accessories []
            â”œâ”€â”€ isActive (boolean)
            â”œâ”€â”€ expression
            â”œâ”€â”€ energy (0-100)
            â”œâ”€â”€ experience (cumulative XP)
            â”œâ”€â”€ level (calculated from XP)
            â”œâ”€â”€ state
            â”œâ”€â”€ outfits
            â”‚   â”œâ”€â”€ unlocked []
            â”‚   â””â”€â”€ equipped
            â”œâ”€â”€ avatarImageUrl
            â”œâ”€â”€ createdAt
            â””â”€â”€ updatedAt
```

---

**Architecture Design**: Modular, Scalable, Mobile-First âœ“  
**Authentication**: JWT Token-based âœ“  
**Database**: MongoDB with Mongoose ORM âœ“  
**API Documentation**: Swagger/OpenAPI âœ“  
